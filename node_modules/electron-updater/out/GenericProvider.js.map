{"version":3,"sources":["../src/GenericProvider.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEM,MAAA,eAAA,SAA+B,gBAA/B,CAAmD;AAGvD,cAA6B,aAA7B,EAAmF,OAAnF,EAAwG,0BAA0B,IAAlI,EAAsI;AACpI,UAAM,QAAQ,YAAd,EAA4B,uBAA5B;AAD2B,SAAA,aAAA,GAAA,aAAA;AAAsD,SAAA,OAAA,GAAA,OAAA;AAFlE,SAAA,OAAA,GAAU,wBAAW,KAAK,aAAL,CAAmB,GAA9B,CAAV;AAIhB;;AAED,MAAY,OAAZ,GAAmB;AACjB,UAAM,SAAS,KAAK,OAAL,CAAa,OAAb,IAAwB,KAAK,aAAL,CAAmB,OAA1D;AACA,WAAO,UAAU,IAAV,GAAiB,oCAAjB,GAA2C,kCAAqB,MAArB,CAAlD;AACD;;AAEK,kBAAN,GAAsB;AAAA;;AAAA;AACpB,UAAI,MAAJ;AACA,YAAM,cAAc,gCAAmB,MAAK,OAAxB,CAApB;AACA,YAAM,aAAa,4BAAe,WAAf,EAA4B,MAAK,OAAjC,EAA0C,MAAK,OAAL,CAAa,iBAAvD,CAAnB;;AACA,WAAK,IAAI,gBAAgB,CAAzB,GAA8B,eAA9B,EAA+C;AAC7C,YAAI;AACF,mBAAS,kCAAgB,MAAM,MAAK,WAAL,CAAiB,UAAjB,CAAtB,GAAoD,WAApD,EAAiE,UAAjE,CAAT;AACA;AACD,SAHD,CAIA,OAAO,CAAP,EAAU;AACR,cAAI,aAAa,+BAAb,IAA0B,EAAE,UAAF,KAAiB,GAA/C,EAAoD;AAClD,kBAAM,oCAAS,wBAAwB,WAAW,kBAAkB,EAAE,KAAF,IAAW,EAAE,OAAO,EAAlF,EAAsF,oCAAtF,CAAN;AACD,WAFD,MAGK,IAAI,EAAE,IAAF,KAAW,cAAf,EAA+B;AAClC,gBAAI,gBAAgB,CAApB,EAAuB;AACrB,oBAAM,IAAI,OAAJ,CAAY,CAAC,OAAD,EAAU,MAAV,KAAoB;AACpC,oBAAI;AACF,6BAAW,OAAX,EAAoB,OAAO,aAA3B;AACD,iBAFD,CAGA,OAAO,CAAP,EAAU;AACR,yBAAO,CAAP;AACD;AACF,eAPK,CAAN;AAQA;AACD;AACF;;AACD,gBAAM,CAAN;AACD;AACF;;AAED,UAAI,kCAAJ,EAA2B;AACxB,eAAe,cAAf,GAAgC,WAAW,IAA3C;AACF;;AACD,aAAO,MAAP;AAjCoB;AAkCrB;;AAED,eAAa,UAAb,EAAmC;AACjC,WAAO,8BAAa,UAAb,EAAyB,KAAK,OAA9B,CAAP;AACD;;AAlDsD","sourcesContent":["import { GenericServerOptions, HttpError, newError, UpdateInfo } from \"builder-util-runtime\"\nimport { AppUpdater } from \"./AppUpdater\"\nimport { getChannelFilename, getCustomChannelName, getDefaultChannelName, isUseOldMacProvider, newBaseUrl, newUrlFromBase, Provider, ResolvedUpdateFileInfo } from \"./main\"\nimport { parseUpdateInfo, resolveFiles } from \"./Provider\"\n\nexport class GenericProvider extends Provider<UpdateInfo> {\n  private readonly baseUrl = newBaseUrl(this.configuration.url)\n\n  constructor(private readonly configuration: GenericServerOptions, private readonly updater: AppUpdater, useMultipleRangeRequest = true) {\n    super(updater.httpExecutor, useMultipleRangeRequest)\n  }\n\n  private get channel(): string {\n    const result = this.updater.channel || this.configuration.channel\n    return result == null ? getDefaultChannelName() : getCustomChannelName(result)\n  }\n\n  async getLatestVersion(): Promise<UpdateInfo> {\n    let result: UpdateInfo\n    const channelFile = getChannelFilename(this.channel)\n    const channelUrl = newUrlFromBase(channelFile, this.baseUrl, this.updater.isAddNoCacheQuery)\n    for (let attemptNumber = 0; ; attemptNumber++) {\n      try {\n        result = parseUpdateInfo(await this.httpRequest(channelUrl), channelFile, channelUrl)\n        break\n      }\n      catch (e) {\n        if (e instanceof HttpError && e.statusCode === 404) {\n          throw newError(`Cannot find channel \"${channelFile}\" update info: ${e.stack || e.message}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n        }\n        else if (e.code === \"ECONNREFUSED\") {\n          if (attemptNumber < 3) {\n            await new Promise((resolve, reject) => {\n              try {\n                setTimeout(resolve, 1000 * attemptNumber)\n              }\n              catch (e) {\n                reject(e)\n              }\n            })\n            continue\n          }\n        }\n        throw e\n      }\n    }\n\n    if (isUseOldMacProvider()) {\n      (result as any).releaseJsonUrl = channelUrl.href\n    }\n    return result\n  }\n\n  resolveFiles(updateInfo: UpdateInfo): Array<ResolvedUpdateFileInfo> {\n    return resolveFiles(updateInfo, this.baseUrl)\n  }\n}"],"sourceRoot":""}
