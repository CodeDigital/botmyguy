{"version":3,"sources":["../src/windowsExecutableCodeSignatureVerifier.ts"],"names":[],"mappings":"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","sourcesContent":["import { parseDn } from \"builder-util-runtime\"\nimport { execFile, execFileSync } from \"child_process\"\nimport * as os from \"os\"\nimport { Logger } from \"./main\"\n\n// $certificateInfo = (Get-AuthenticodeSignature 'xxx\\yyy.exe'\n// | where {$_.Status.Equals([System.Management.Automation.SignatureStatus]::Valid) -and $_.SignerCertificate.Subject.Contains(\"CN=siemens.com\")})\n// | Out-String ; if ($certificateInfo) { exit 0 } else { exit 1 }\nexport function verifySignature(publisherNames: Array<string>, tempUpdateFile: string, logger: Logger): Promise<string | null> {\n  return new Promise<string | null>(resolve => {\n    // https://github.com/electron-userland/electron-builder/issues/2421\n    // https://github.com/electron-userland/electron-builder/issues/2535\n    execFile(\"powershell.exe\", [\"-NoProfile\", \"-NonInteractive\", \"-InputFormat\", \"None\", \"-Command\", `Get-AuthenticodeSignature '${tempUpdateFile}' | ConvertTo-Json -Compress`], {\n      timeout: 20 * 1000\n    }, (error, stdout, stderr) => {\n      try {\n        if (error != null || stderr) {\n          handleError(logger, error, stderr)\n          resolve(null)\n          return\n        }\n\n        const data = parseOut(stdout)\n        if (data.Status === 0) {\n          const name = parseDn(data.SignerCertificate.Subject).get(\"CN\")!\n          if (publisherNames.includes(name)) {\n            resolve(null)\n            return\n          }\n        }\n\n        const result = `publisherNames: ${publisherNames.join(\" | \")}, raw info: ` + JSON.stringify(data, (name, value) => name === \"RawData\" ? undefined : value, 2)\n        logger.warn(`Sign verification failed, installer signed with incorrect certificate: ${result}`)\n        resolve(result)\n      }\n      catch (e) {\n        logger.warn(`Cannot execute Get-AuthenticodeSignature: ${error}. Ignoring signature validation due to unknown error.`)\n        resolve(null)\n        return\n      }\n    })\n  })\n}\n\nfunction parseOut(out: string): any {\n  const data = JSON.parse(out)\n  delete data.PrivateKey\n  delete data.IsOSBinary\n  delete data.SignatureType\n  const signerCertificate = data.SignerCertificate\n  if (signerCertificate != null) {\n    delete signerCertificate.Archived\n    delete signerCertificate.Extensions\n    delete signerCertificate.Handle\n    delete signerCertificate.HasPrivateKey\n    // duplicates data.SignerCertificate (contains RawData)\n    delete signerCertificate.SubjectName\n  }\n  delete data.Path\n  return data\n}\n\nfunction handleError(logger: Logger, error: Error | null, stderr: string | null) {\n  if (isOldWin6()) {\n    logger.warn(`Cannot execute Get-AuthenticodeSignature: ${error || stderr}. Ignoring signature validation due to unsupported powershell version. Please upgrade to powershell 3 or higher.`)\n    return\n  }\n\n  try {\n    execFileSync(\"powershell.exe\", [\"-NoProfile\", \"-NonInteractive\", \"-Command\", \"ConvertTo-Json test\"], {timeout: 10 * 1000})\n  }\n  catch (testError) {\n    logger.warn(`Cannot execute ConvertTo-Json: ${testError.message}. Ignoring signature validation due to unsupported powershell version. Please upgrade to powershell 3 or higher.`)\n    return\n  }\n\n  if (error != null) {\n    throw error\n  }\n\n  if (stderr) {\n    logger.warn(`Cannot execute Get-AuthenticodeSignature, stderr: ${stderr}. Ignoring signature validation due to unknown stderr.`)\n    return\n  }\n}\n\nfunction isOldWin6() {\n  const winVersion = os.release()\n  return winVersion.startsWith(\"6.\") && !winVersion.startsWith(\"6.3\")\n}\n"],"sourceRoot":""}
