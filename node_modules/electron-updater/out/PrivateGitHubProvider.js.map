{"version":3,"sources":["../src/PrivateGitHubProvider.ts"],"names":[],"mappings":"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","sourcesContent":["import { CancellationToken, GithubOptions, HttpError, HttpExecutor, newError, UpdateInfo } from \"builder-util-runtime\"\nimport { OutgoingHttpHeaders, RequestOptions } from \"http\"\nimport { safeLoad } from \"js-yaml\"\nimport * as path from \"path\"\nimport { AppUpdater } from \"./AppUpdater\"\nimport { URL } from \"url\"\nimport { BaseGitHubProvider } from \"./GitHubProvider\"\nimport { getChannelFilename, getDefaultChannelName, newUrlFromBase, ResolvedUpdateFileInfo } from \"./main\"\nimport { getFileList } from \"./Provider\"\n\nexport interface PrivateGitHubUpdateInfo extends UpdateInfo {\n  assets: Array<Asset>\n}\n\nexport class PrivateGitHubProvider extends BaseGitHubProvider<PrivateGitHubUpdateInfo> {\n  constructor(options: GithubOptions, private readonly updater: AppUpdater, private readonly token: string, executor: HttpExecutor<any>) {\n    super(options, \"api.github.com\", executor)\n  }\n\n  protected createRequestOptions(url: URL, headers?: OutgoingHttpHeaders | null): RequestOptions {\n    const result = super.createRequestOptions(url, headers);\n    (result as any).redirect = \"manual\"\n    return result\n  }\n\n  async getLatestVersion(): Promise<PrivateGitHubUpdateInfo> {\n    const cancellationToken = new CancellationToken()\n    const channelFile = getChannelFilename(getDefaultChannelName())\n\n    const releaseInfo = await this.getLatestVersionInfo(cancellationToken)\n    const asset = releaseInfo.assets.find(it => it.name === channelFile)\n    if (asset == null) {\n      // html_url must be always, but just to be sure\n      throw newError(`Cannot find ${channelFile} in the release ${releaseInfo.html_url || releaseInfo.name}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n    }\n\n    const url = new URL(asset.url)\n    let result: any\n    try {\n      result = safeLoad((await this.httpRequest(url, this.configureHeaders(\"application/octet-stream\"), cancellationToken))!!)\n    }\n    catch (e) {\n      if (e instanceof HttpError && e.statusCode === 404) {\n        throw newError(`Cannot find ${channelFile} in the latest release artifacts (${url}): ${e.stack || e.message}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n      }\n      throw e\n    }\n\n    (result as PrivateGitHubUpdateInfo).assets = releaseInfo.assets\n    return result\n  }\n\n  get fileExtraDownloadHeaders(): OutgoingHttpHeaders | null {\n    return this.configureHeaders(\"application/octet-stream\")\n  }\n\n  private configureHeaders(accept: string) {\n    return {\n      accept,\n      authorization: `token ${this.token}`,\n    }\n  }\n\n  private async getLatestVersionInfo(cancellationToken: CancellationToken): Promise<ReleaseInfo> {\n    let baseUrl = this.basePath\n    const allowPrerelease = this.updater.allowPrerelease\n\n    if (!allowPrerelease) {\n      baseUrl = `${baseUrl}/latest`\n    }\n\n    const url = newUrlFromBase(`${baseUrl}`, this.baseUrl)\n    try {\n      let version = (JSON.parse((await this.httpRequest(url, this.configureHeaders(\"application/vnd.github.v3+json\"), cancellationToken))!!))\n      if (allowPrerelease) {\n        version = version.find((v: any) => v.prerelease)\n      }\n      return version\n    }\n    catch (e) {\n      throw newError(`Unable to find latest version on GitHub (${url}), please ensure a production release exists: ${e.stack || e.message}`, \"ERR_UPDATER_LATEST_VERSION_NOT_FOUND\")\n    }\n  }\n\n  private get basePath() {\n    return this.computeGithubBasePath(`/repos/${this.options.owner}/${this.options.repo}/releases`)\n  }\n\n  resolveFiles(updateInfo: PrivateGitHubUpdateInfo): Array<ResolvedUpdateFileInfo> {\n    return getFileList(updateInfo).map(it => {\n      const name = path.posix.basename(it.url).replace(/ /g, \"-\")\n      const asset = updateInfo.assets.find(it => it != null && it.name === name)\n      if (asset == null) {\n        throw newError(`Cannot find asset \"${name}\" in: ${JSON.stringify(updateInfo.assets, null, 2)}`, \"ERR_UPDATER_ASSET_NOT_FOUND\")\n      }\n\n      return {\n        url: new URL(asset.url),\n        info: it,\n      }\n    })\n  }\n}\n\ninterface ReleaseInfo {\n  name: string\n  html_url: string\n  assets: Array<Asset>\n}\n\nexport interface Asset {\n  name: string\n  url: string\n}"],"sourceRoot":""}
