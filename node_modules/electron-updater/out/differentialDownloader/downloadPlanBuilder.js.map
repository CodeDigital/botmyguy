{"version":3,"sources":["../../src/differentialDownloader/downloadPlanBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockMap, BlockMapFile } from \"builder-util-runtime/out/blockMapApi\"\nimport { Logger } from \"../main\"\n\nexport enum OperationKind {\n  COPY, DOWNLOAD\n}\n\nexport interface Operation {\n  kind: OperationKind\n\n  start: number\n  end: number\n}\n\nexport function computeOperations(oldBlockMap: BlockMap, newBlockMap: BlockMap, logger: Logger) {\n  const nameToOldBlocks = buildBlockFileMap(oldBlockMap.files)\n  const nameToNewBlocks = buildBlockFileMap(newBlockMap.files)\n\n  const oldEntryMap = buildEntryMap(oldBlockMap.files)\n\n  let lastOperation: Operation | null = null\n\n  const operations: Array<Operation> = []\n  for (const blockMapFile of newBlockMap.files) {\n    const name = blockMapFile.name\n    const oldEntry = oldEntryMap.get(name)\n    if (oldEntry == null) {\n      // new file\n      operations.push({\n        kind: OperationKind.DOWNLOAD,\n        start: blockMapFile.offset,\n        end: blockMapFile.offset + blockMapFile.sizes.reduce((accumulator, currentValue) => accumulator + currentValue),\n      })\n      continue\n    }\n\n    const newFile = nameToNewBlocks.get(name)!!\n    let changedBlockCount = 0\n\n    const {checksumToOffset: checksumToOldOffset, checksumToOldSize} = buildChecksumMap(nameToOldBlocks.get(name)!!, oldEntry.offset)\n\n    let newOffset = blockMapFile.offset\n    for (let i = 0; i < newFile.checksums.length; newOffset += newFile.sizes[i], i++) {\n      const blockSize = newFile.sizes[i]\n      const checksum = newFile.checksums[i]\n      let oldOffset: number | null | undefined = checksumToOldOffset.get(checksum)\n      if (oldOffset != null && checksumToOldSize.get(checksum) !== blockSize) {\n        logger.warn(`Checksum (\"${checksum}\") matches, but size differs (old: ${checksumToOldSize.get(checksum)}, new: ${blockSize})`)\n        oldOffset = null\n      }\n\n      if (oldOffset == null) {\n        changedBlockCount++\n\n        if (lastOperation == null || lastOperation.kind !== OperationKind.DOWNLOAD || lastOperation.end !== newOffset) {\n          lastOperation = {\n            kind: OperationKind.DOWNLOAD,\n            start: newOffset,\n            end: newOffset + blockSize,\n          }\n          operations.push(lastOperation)\n        }\n        else {\n          lastOperation.end += blockSize\n        }\n      }\n      else if (lastOperation == null || lastOperation.kind !== OperationKind.COPY || lastOperation.end !== oldOffset) {\n        lastOperation = {\n          kind: OperationKind.COPY,\n          start: oldOffset,\n          end: oldOffset + blockSize,\n        }\n        operations.push(lastOperation)\n      }\n      else {\n        lastOperation.end += blockSize\n      }\n    }\n\n    if (changedBlockCount > 0) {\n      logger.info(`File${blockMapFile.name === \"file\" ? \"\" : (\" \" + blockMapFile.name)} has ${changedBlockCount} changed blocks`)\n    }\n  }\n  return operations\n}\n\nfunction buildChecksumMap(file: BlockMapFile, fileOffset: number) {\n  const checksumToOffset = new Map<string, number>()\n  const checksumToSize = new Map<string, number>()\n  let offset = fileOffset\n  for (let i = 0; i < file.checksums.length; i++) {\n    const checksum = file.checksums[i]\n    const size = file.sizes[i]\n    checksumToOffset.set(checksum, offset)\n    checksumToSize.set(checksum, size)\n    offset += size\n  }\n  return {checksumToOffset, checksumToOldSize: checksumToSize}\n}\n\nfunction buildEntryMap(list: Array<BlockMapFile>) {\n  const result = new Map<string, BlockMapFile>()\n  for (const item of list) {\n    result.set(item.name, item)\n  }\n  return result\n}\n\nfunction buildBlockFileMap(list: Array<BlockMapFile>) {\n  const result = new Map<string, BlockMapFile>()\n  for (const item of list) {\n    result.set(item.name, item)\n  }\n  return result\n}"],"sourceRoot":""}
